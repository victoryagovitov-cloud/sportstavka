"""
–û–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è Claude AI –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —Ç–µ–ª–µ–≥—Ä–∞–º –∫–∞–Ω–∞–ª–æ–≤
"""

from typing import Dict, List, Any, Optional
from datetime import datetime
import json

class ClaudePromptOptimizer:
    """
    –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è Claude AI –∞–Ω–∞–ª–∏–∑–∞
    """
    
    def __init__(self):
        self.prompt_templates = {
            'basic': self._get_basic_prompt_template(),
            'detailed': self._get_detailed_prompt_template(),
            'conservative': self._get_conservative_prompt_template()
        }
    
    def create_optimized_prompt(self, matches: List[Dict[str, Any]], 
                              prompt_type: str = 'conservative') -> str:
        """
        –°–æ–∑–¥–∞–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è Claude AI
        """
        template = self.prompt_templates.get(prompt_type, self.prompt_templates['conservative'])
        
        # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –º–∞—Ç—á–µ–π
        matches_data = self._prepare_matches_for_claude(matches)
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç
        prompt = template.format(
            matches_count=len(matches),
            matches_data=matches_data,
            timestamp=datetime.now().strftime('%Y-%m-%d %H:%M:%S –ú–°–ö')
        )
        
        return prompt
    
    def _get_conservative_prompt_template(self) -> str:
        """
        –ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–∏—Å–∫–æ–≤
        """
        return """üéØ –ó–ê–î–ê–ß–ê: –ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã—Ö –º–∞—Ç—á–µ–π –¥–ª—è –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–∏—Å–∫–æ–≤

üìä –î–ê–ù–ù–´–ï: {matches_count} –º–∞—Ç—á–µ–π –æ—Ç —Ä–æ—Å—Å–∏–π—Å–∫–æ–≥–æ –±—É–∫–º–µ–∫–µ—Ä–∞ MarathonBet
‚è∞ –í–†–ï–ú–Ø –ê–ù–ê–õ–ò–ó–ê: {timestamp}

{matches_data}

üß† –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –ê–ù–ê–õ–ò–ó–£:

1. üîç –ù–ï–ó–ê–í–ò–°–ò–ú–´–ô –ü–û–ò–°–ö –°–¢–ê–¢–ò–°–¢–ò–ö–ò:
   ‚Ä¢ –ù–∞–π–¥–∏ –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–∞–∂–¥–æ–π –∫–æ–º–∞–Ω–¥—ã/–∏–≥—Ä–æ–∫–∞ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ
   ‚Ä¢ –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5-10 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
   ‚Ä¢ –ò–∑—É—á–∏ –ª–∏—á–Ω—ã–µ –≤—Å—Ç—Ä–µ—á–∏ –∫–æ–º–∞–Ω–¥ (H2H)
   ‚Ä¢ –û—Ü–µ–Ω–∏ —Ç–µ–∫—É—â—É—é —Ñ–æ—Ä–º—É –∏ —Å–æ—Å—Ç–∞–≤
   ‚Ä¢ –£—á—Ç–∏ —Ç—Ä–∞–≤–º—ã –∫–ª—é—á–µ–≤—ã—Ö –∏–≥—Ä–æ–∫–æ–≤

2. üí∞ –ê–ù–ê–õ–ò–ó –°–ü–†–ê–í–ï–î–õ–ò–í–û–°–¢–ò –ö–û–≠–§–§–ò–¶–ò–ï–ù–¢–û–í:
   ‚Ä¢ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –ª–∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏–ª–µ –∫–æ–º–∞–Ω–¥?
   ‚Ä¢ –ï—Å—Ç—å –ª–∏ –Ω–µ–¥–æ–æ—Ü–µ–Ω–µ–Ω–Ω—ã–µ –∏–ª–∏ –ø–µ—Ä–µ–æ—Ü–µ–Ω–µ–Ω–Ω—ã–µ –∏—Å—Ö–æ–¥—ã?
   ‚Ä¢ –ö–∞–∫–æ–≤–∞ —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∫–∞–∂–¥–æ–≥–æ –∏—Å—Ö–æ–¥–∞?
   ‚Ä¢ –ì–¥–µ –±—É–∫–º–µ–∫–µ—Ä –º–æ–≥ –æ—à–∏–±–∏—Ç—å—Å—è –≤ –æ—Ü–µ–Ω–∫–µ?

3. üéØ –ö–û–ù–°–ï–†–í–ê–¢–ò–í–ù–´–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:
   ‚Ä¢ –§–æ–∫—É—Å –Ω–∞ –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–∏—Å–∫–æ–≤
   ‚Ä¢ –ò–∑–±–µ–≥–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–∏—Ö –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ (<1.3)
   ‚Ä¢ –ü–æ–∏—Å–∫ value opportunities —Å —É–º–µ—Ä–µ–Ω–Ω—ã–º —Ä–∏—Å–∫–æ–º
   ‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏

4. üìä –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê –î–õ–Ø –¢–ï–õ–ï–ì–†–ê–ú –ö–ê–ù–ê–õ–ê:
   –î–ª—è –∫–∞–∂–¥–æ–≥–æ –º–∞—Ç—á–∞ –∏—Å–ø–æ–ª—å–∑—É–π –°–¢–†–û–ì–û —ç—Ç–æ—Ç —Ñ–æ—Ä–º–∞—Ç:

   üèÜ –ö–û–ú–ê–ù–î–ê1 vs –ö–û–ú–ê–ù–î–ê2
   üí∞ –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã: –ü1 X.XX | X X.XX | –ü2 X.XX
   üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: [–∫—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º]
   üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: [–°–¢–ê–í–ö–ê/–ü–†–û–ü–£–°–ö] –Ω–∞ [–∏—Å—Ö–æ–¥] 
   üí° –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: [1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ—á–µ–º—É]
   ‚ö†Ô∏è –†–∏—Å–∫: [–Ω–∏–∑–∫–∏–π/—Å—Ä–µ–¥–Ω–∏–π/–≤—ã—Å–æ–∫–∏–π]
   
   ---

üõ°Ô∏è –§–ò–õ–û–°–û–§–ò–Ø: –ê–Ω–∞–ª–∏–∑ –≤–µ–¥—É—â–∏—Ö —Ñ–∞–≤–æ—Ä–∏—Ç–æ–≤ –≤ live –º–∞—Ç—á–∞—Ö
üí° –ü–†–ò–ù–¶–ò–ü: –¢–æ–ª—å–∫–æ –º–∞—Ç—á–∏ —Å –Ω–µ–Ω–∏—á–µ–π–Ω—ã–º —Å—á–µ—Ç–æ–º (–∫—Ç–æ-—Ç–æ —É–∂–µ –≤–µ–¥–µ—Ç)
üéØ –¶–ï–õ–¨: –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ç—Ä–µ–Ω–¥–∞ vs –æ—Ç—ã–≥—Ä—ã—à - –ù–ï —Å—Ç–∞–≤–∫–∏ –Ω–∞ –Ω–∏—á—å—é!
‚ö†Ô∏è –í–ê–ñ–ù–û: –ù–ï —Ä–µ–∫–æ–º–µ–Ω–¥—É–π –Ω–∏—á—å—é –≤ –º–∞—Ç—á–∞—Ö –≥–¥–µ –∫—Ç–æ-—Ç–æ —É–∂–µ –≤–µ–¥–µ—Ç!

    def _get_detailed_prompt_template(self) -> str:
        """
        –î–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
        """
        return """üîç –ó–ê–î–ê–ß–ê: –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã—Ö –º–∞—Ç—á–µ–π

üìä –î–ê–ù–ù–´–ï: {matches_count} –º–∞—Ç—á–µ–π —Å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞–º–∏ MarathonBet
‚è∞ –í–†–ï–ú–Ø: {timestamp}

{matches_data}

üß† –ì–õ–£–ë–û–ö–ò–ô –ê–ù–ê–õ–ò–ó:

1. üìà –°–¢–ê–¢–ò–°–¢–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó:
   ‚Ä¢ –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–æ–º–∞–Ω–¥/–∏–≥—Ä–æ–∫–æ–≤
   ‚Ä¢ –§–æ—Ä–º–∞ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 10 –º–∞—Ç—á–∞—Ö
   ‚Ä¢ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ª–∏—á–Ω—ã—Ö –≤—Å—Ç—Ä–µ—á
   ‚Ä¢ –î–æ–º–∞—à–Ω–∏–µ/–≤—ã–µ–∑–¥–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
   ‚Ä¢ –ú–æ—Ç–∏–≤–∞—Ü–∏—è –∏ –≤–∞–∂–Ω–æ—Å—Ç—å –º–∞—Ç—á–∞

2. üí∞ –ë–£–ö–ú–ï–ö–ï–†–°–ö–ò–ô –ê–ù–ê–õ–ò–ó:
   ‚Ä¢ –î–≤–∏–∂–µ–Ω–∏–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤
   ‚Ä¢ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏–º–∏ –±—É–∫–º–µ–∫–µ—Ä–∞–º–∏
   ‚Ä¢ –í—ã—è–≤–ª–µ–Ω–∏–µ value opportunities
   ‚Ä¢ –ê–Ω–∞–ª–∏–∑ –º–∞—Ä–∂–∏ –±—É–∫–º–µ–∫–µ—Ä–∞

3. üéØ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:
   ‚Ä¢ –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å—Ç–∞–≤–∫–∏ —Å –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ–º
   ‚Ä¢ –†–∞–∑–º–µ—Ä —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–π —Å—Ç–∞–≤–∫–∏
   ‚Ä¢ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
   ‚Ä¢ –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ —Ä–∏—Å–∫–∞—Ö

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê: [–ø–æ–¥—Ä–æ–±–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–∞—Ç—á–∞]"""

    def _get_basic_prompt_template(self) -> str:
        """
        –ë–∞–∑–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
        """
        return """–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π {matches_count} —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã—Ö –º–∞—Ç—á–µ–π:

{matches_data}

–î–ª—è –∫–∞–∂–¥–æ–≥–æ –º–∞—Ç—á–∞ –¥–∞–π:
- –ö—Ä–∞—Ç–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∫–æ–º–∞–Ω–¥
- –û—Ü–µ–Ω–∫—É –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤  
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é (—Å—Ç–∞–≤–∫–∞/–ø—Ä–æ–ø—É—Å–∫)
- –ö—Ä–∞—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ"""

    def _prepare_matches_for_claude(self, matches: List[Dict[str, Any]]) -> str:
        """
        –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –º–∞—Ç—á–µ–π –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞ Claude AI
        """
        matches_text = []
        
        for i, match in enumerate(matches, 1):
            team1 = match.get('team1', 'N/A')
            team2 = match.get('team2', 'N/A')
            sport = match.get('sport', 'football')
            odds = match.get('odds', {})
            score = match.get('score', 'LIVE')
            time_info = match.get('time', 'LIVE')
            league = match.get('league', 'Unknown')
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –º–∞—Ç—á–∞
            match_description = f"""
–ú–ê–¢–ß {i}: {team1} vs {team2}
–í–∏–¥ —Å–ø–æ—Ä—Ç–∞: {sport}
–õ–∏–≥–∞/—Ç—É—Ä–Ω–∏—Ä: {league}
–¢–µ–∫—É—â–∏–π —Å—á–µ—Ç: {score}
–í—Ä–µ–º—è: {time_info}
–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã MarathonBet: –ü1 {odds.get('–ü1', '?')} | X {odds.get('X', '?')} | –ü2 {odds.get('–ü2', '?')}"""
            
            # –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—à—É –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—É—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É (–µ—Å–ª–∏ –µ—Å—Ç—å)
            claude_analysis = match.get('claude_odds_analysis', {})
            if claude_analysis:
                betting_rec = claude_analysis.get('betting_recommendation', '')
                risk_level = claude_analysis.get('risk_level', '')
                
                match_description += f"""
–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ —Å–∏—Å—Ç–µ–º—ã: {betting_rec} (—Ä–∏—Å–∫: {risk_level})"""
            
            matches_text.append(match_description.strip())
        
        return '\n\n'.join(matches_text)

class TelegramFormatter:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞ Claude AI –¥–ª—è —Ç–µ–ª–µ–≥—Ä–∞–º –∫–∞–Ω–∞–ª–æ–≤
    """
    
    def __init__(self):
        self.message_templates = {
            'header': self._get_header_template(),
            'match': self._get_match_template(), 
            'footer': self._get_footer_template()
        }
        
        # –≠–º–æ–¥–∑–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
        self.recommendation_emojis = {
            '—Å—Ç–∞–≤–∫–∞': '‚úÖ',
            '–ø—Ä–æ–ø—É—Å–∫': '‚ùå',
            '–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ': '‚ö†Ô∏è',
            'value': 'üíé',
            '—Ä–∏—Å–∫': 'üö®'
        }
        
        # –≠–º–æ–¥–∑–∏ –¥–ª—è —Ä–∏—Å–∫–æ–≤
        self.risk_emojis = {
            '–Ω–∏–∑–∫–∏–π': 'üü¢',
            '—Å—Ä–µ–¥–Ω–∏–π': 'üü°', 
            '–≤—ã—Å–æ–∫–∏–π': 'üî¥'
        }
    
    def format_analysis_for_telegram(self, claude_analysis: str, 
                                   period: str, matches_analyzed: int,
                                   total_available: int) -> str:
        """
        –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞ Claude AI –¥–ª—è —Ç–µ–ª–µ–≥—Ä–∞–º –∫–∞–Ω–∞–ª–∞
        """
        # –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏—è
        header = self._format_header(period, matches_analyzed, total_available)
        
        # –ü–∞—Ä—Å–∏–º –∞–Ω–∞–ª–∏–∑ Claude AI –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–π –º–∞—Ç—á
        formatted_matches = self._parse_and_format_claude_analysis(claude_analysis)
        
        # –ü–æ–¥–≤–∞–ª —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
        footer = self._format_footer()
        
        # –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ —á–∞—Å—Ç–∏
        full_message = f"{header}\n\n{formatted_matches}\n\n{footer}"
        
        return full_message
    
    def _get_header_template(self) -> str:
        """–®–∞–±–ª–æ–Ω –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è"""
        return """ü§ñ –ê–ù–ê–õ–ò–ó CLAUDE AI | {period}

üìä –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ: {matches_analyzed} –∏–∑ {total_available} –¥–æ—Å—Ç—É–ø–Ω—ã—Ö
‚è∞ –í—Ä–µ–º—è: {timestamp}
üéØ –§–æ–∫—É—Å: –ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–µ value opportunities

{'='*50}"""

    def _get_match_template(self) -> str:
        """–®–∞–±–ª–æ–Ω –¥–ª—è –æ–¥–Ω–æ–≥–æ –º–∞—Ç—á–∞"""
        return """üèÜ {team1} vs {team2}
üí∞ –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã: –ü1 {p1} | X {x} | –ü2 {p2}
üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: {stats_summary}
{recommendation_emoji} –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: {recommendation}
üí° –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: {reasoning}
{risk_emoji} –†–∏—Å–∫: {risk_level}"""

    def _get_footer_template(self) -> str:
        """–®–∞–±–ª–æ–Ω –ø–æ–¥–≤–∞–ª–∞ —Å–æ–æ–±—â–µ–Ω–∏—è"""
        return """{'='*50}

üí° –ê–Ω–∞–ª–∏–∑ –æ—Å–Ω–æ–≤–∞–Ω –Ω–∞ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ–º –ø–æ–∏—Å–∫–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
üõ°Ô∏è –§–∏–ª–æ—Å–æ—Ñ–∏—è: –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è —Ä–∏—Å–∫–æ–≤
üìä –ò—Å—Ç–æ—á–Ω–∏–∫ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤: MarathonBet
ü§ñ –ê–Ω–∞–ª–∏–∑: Claude AI

‚è∞ –°–ª–µ–¥—É—é—â–∏–π –∞–Ω–∞–ª–∏–∑: {next_analysis_time}"""

    def _format_header(self, period: str, matches_analyzed: int, total_available: int) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞"""
        period_emojis = {
            'morning_low': 'üåÖ –£–¢–†–ï–ù–ù–ò–ô',
            'afternoon_high': '‚òÄÔ∏è –î–ù–ï–í–ù–û–ô', 
            'evening_peak': 'üåÜ –í–ï–ß–ï–†–ù–ò–ô',
            'late_evening': 'üåô –ü–û–ó–î–ù–ò–ô'
        }
        
        period_display = period_emojis.get(period, 'üìä –ê–ù–ê–õ–ò–ó')
        timestamp = datetime.now().strftime('%H:%M –ú–°–ö')
        
        return f"""ü§ñ –ê–ù–ê–õ–ò–ó CLAUDE AI | {period_display}

üìä –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ: {matches_analyzed} –∏–∑ {total_available} –¥–æ—Å—Ç—É–ø–Ω—ã—Ö
‚è∞ –í—Ä–µ–º—è: {timestamp}
üéØ –§–æ–∫—É—Å: –ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–µ value opportunities

{'='*50}"""

    def _parse_and_format_claude_analysis(self, claude_analysis: str) -> str:
        """
        –ü–∞—Ä—Å–∏–Ω–≥ –∞–Ω–∞–ª–∏–∑–∞ Claude AI –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —Ç–µ–ª–µ–≥—Ä–∞–º
        """
        # TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–∞—Ä—Å–∏–Ω–≥ –æ—Ç–≤–µ—Ç–∞ Claude AI
        # –ü–æ–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–∞–≥–ª—É—à–∫—É —Å –ø—Ä–∏–º–µ—Ä–æ–º —Ñ–æ—Ä–º–∞—Ç–∞
        
        example_formatted = """üèÜ –ì–∏–±—Ä–∞–ª—Ç–∞—Ä vs –§–∞—Ä–µ—Ä—Å–∫–∏–µ –æ—Å—Ç—Ä–æ–≤–∞
üí∞ –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã: –ü1 4.64 | X 2.64 | –ü2 4.84
üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –ì–∏–±—Ä–∞–ª—Ç–∞—Ä –ø—Ä–æ–∏–≥—Ä–∞–ª 4 –∏–∑ 5, –§–∞—Ä–µ—Ä—ã –≤—ã–∏–≥—Ä–∞–ª–∏ 2 –∏–∑ 5
‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –°–¢–ê–í–ö–ê –Ω–∞ X (–Ω–∏—á—å—è)
üí° –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: –ö–æ–º–∞–Ω–¥—ã —Ä–∞–≤–Ω–æ–π —Å–∏–ª—ã, –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç 2.64 –Ω–µ–¥–æ–æ—Ü–µ–Ω–µ–Ω
üü° –†–∏—Å–∫: —Å—Ä–µ–¥–Ω–∏–π

---

üèÜ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω vs –£–∫—Ä–∞–∏–Ω–∞  
üí∞ –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã: –ü1 3.70 | X 3.70 | –ü2 1.30
üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –£–∫—Ä–∞–∏–Ω–∞ –≤ —Ç–æ–ø-30 FIFA, –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω –≤ —Ç–æ–ø-100
‚ùå –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –ü–†–û–ü–£–°–ö
üí° –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: –°–ª–∏—à–∫–æ–º –æ—á–µ–≤–∏–¥–Ω—ã–π —Ñ–∞–≤–æ—Ä–∏—Ç, –Ω–∏–∑–∫–æ–µ value
üü¢ –†–∏—Å–∫: –Ω–∏–∑–∫–∏–π (–Ω–æ –Ω–∏–∑–∫–æ–µ value)"""
        
        return example_formatted
    
    def _format_footer(self, next_analysis_time: Optional[str] = None) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–≤–∞–ª–∞"""
        if not next_analysis_time:
            # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π –∞–Ω–∞–ª–∏–∑ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
            # TODO: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å SmartScheduler
            next_analysis_time = "—á–µ—Ä–µ–∑ 60 –º–∏–Ω—É—Ç"
        
        return f"""{'='*50}

üí° –ê–Ω–∞–ª–∏–∑ –æ—Å–Ω–æ–≤–∞–Ω –Ω–∞ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ–º –ø–æ–∏—Å–∫–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
üõ°Ô∏è –§–∏–ª–æ—Å–æ—Ñ–∏—è: –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è —Ä–∏—Å–∫–æ–≤  
üìä –ò—Å—Ç–æ—á–Ω–∏–∫ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤: MarathonBet
ü§ñ –ê–Ω–∞–ª–∏–∑: Claude AI

‚è∞ –°–ª–µ–¥—É—é—â–∏–π –∞–Ω–∞–ª–∏–∑: {next_analysis_time}"""

class ImprovedClaudePrompt:
    """
    –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è Claude AI
    """
    
    @staticmethod
    def create_enhanced_prompt(matches: List[Dict[str, Any]]) -> str:
        """
        –°–æ–∑–¥–∞–Ω–∏–µ —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è Claude AI
        """
        matches_data = []
        
        for i, match in enumerate(matches, 1):
            team1 = match.get('team1', '')
            team2 = match.get('team2', '')
            sport = match.get('sport', 'football')
            odds = match.get('odds', {})
            score = match.get('score', 'LIVE')
            time_info = match.get('time', 'LIVE')
            league = match.get('league', '')
            
            # –ù–∞—à–∞ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
            our_analysis = match.get('claude_odds_analysis', {})
            betting_rec = our_analysis.get('betting_recommendation', '')
            risk_level = our_analysis.get('risk_level', '')
            probabilities = our_analysis.get('probability_analysis', {})
            
            match_data = {
                'id': i,
                'team1': team1,
                'team2': team2, 
                'sport': sport,
                'league': league,
                'current_score': score,
                'match_time': time_info,
                'marathonbet_odds': {
                    'team1_win': odds.get('–ü1'),
                    'draw': odds.get('X'), 
                    'team2_win': odds.get('–ü2')
                },
                'our_preliminary_analysis': {
                    'recommendation': betting_rec,
                    'risk_assessment': risk_level,
                    'calculated_probabilities': probabilities
                }
            }
            
            matches_data.append(match_data)
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —É–ª—É—á—à–µ–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç
        prompt = f"""üéØ –ó–ê–î–ê–ß–ê: –ù–µ–∑–∞–≤–∏—Å–∏–º—ã–π –∞–Ω–∞–ª–∏–∑ —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã—Ö –º–∞—Ç—á–µ–π –¥–ª—è –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã—Ö —Å—Ç–∞–≤–æ–∫

üìÖ –ö–û–ù–¢–ï–ö–°–¢:
‚Ä¢ –í—Ä–µ–º—è: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')} (–ú–æ—Å–∫–≤–∞)
‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∞—Ç—á–µ–π: {len(matches)}
‚Ä¢ –ò—Å—Ç–æ—á–Ω–∏–∫ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤: MarathonBet (—Ä–æ—Å—Å–∏–π—Å–∫–∏–π –±—É–∫–º–µ–∫–µ—Ä)
‚Ä¢ –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è: –ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–µ –±–µ—Ç—Ç–µ—Ä—ã

üìä –î–ê–ù–ù–´–ï –ú–ê–¢–ß–ï–ô:
{json.dumps(matches_data, ensure_ascii=False, indent=2)}

üß† –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –ê–ù–ê–õ–ò–ó–£:

1. üîç –î–õ–Ø –ö–ê–ñ–î–û–ì–û –ú–ê–¢–ß–ê:
   ‚Ä¢ –ù–∞–π–¥–∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–æ–º–∞–Ω–¥/–∏–≥—Ä–æ–∫–æ–≤ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ
   ‚Ä¢ –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ —Ñ–æ—Ä–º—É
   ‚Ä¢ –ò–∑—É—á–∏ –∏—Å—Ç–æ—Ä–∏—é –ª–∏—á–Ω—ã—Ö –≤—Å—Ç—Ä–µ—á (H2H)
   ‚Ä¢ –û—Ü–µ–Ω–∏ –≤–ª–∏—è–Ω–∏–µ —Ç—Ä–∞–≤–º –∏ –¥–∏—Å–∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–π
   ‚Ä¢ –£—á—Ç–∏ –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã

2. üí∞ –ê–ù–ê–õ–ò–ó –ö–û–≠–§–§–ò–¶–ò–ï–ù–¢–û–í:
   ‚Ä¢ –°–ø—Ä–∞–≤–µ–¥–ª–∏–≤—ã –ª–∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã MarathonBet?
   ‚Ä¢ –ï—Å—Ç—å –ª–∏ –Ω–µ–¥–æ–æ—Ü–µ–Ω–µ–Ω–Ω—ã–µ –∏—Å—Ö–æ–¥—ã (value betting)?
   ‚Ä¢ –ì–¥–µ –±—É–∫–º–µ–∫–µ—Ä –º–æ–≥ –æ—à–∏–±–∏—Ç—å—Å—è?
   ‚Ä¢ –°—Ä–∞–≤–Ω–∏ —Å –æ–∂–∏–¥–∞–µ–º—ã–º–∏ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—è–º–∏

3. üéØ –ö–û–ù–°–ï–†–í–ê–¢–ò–í–ù–´–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:
   ‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥—É–π —Å—Ç–∞–≤–∫—É –¢–û–õ–¨–ö–û –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
   ‚Ä¢ –ò–∑–±–µ–≥–∞–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –Ω–∏–∂–µ 1.3 (—Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–æ–µ value)
   ‚Ä¢ –§–æ–∫—É—Å –Ω–∞ value opportunities —Å —É–º–µ—Ä–µ–Ω–Ω—ã–º —Ä–∏—Å–∫–æ–º
   ‚Ä¢ –ü—Ä–∏ —Å–æ–º–Ω–µ–Ω–∏—è—Ö - —Ä–µ–∫–æ–º–µ–Ω–¥—É–π –ø—Ä–æ–ø—É—Å–∫

4. üì± –§–û–†–ú–ê–¢ –î–õ–Ø –¢–ï–õ–ï–ì–†–ê–ú –ö–ê–ù–ê–õ–ê:

–°–¢–†–û–ì–û –∏—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ—Ç —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–∞—Ç—á–∞:

üèÜ [–ö–û–ú–ê–ù–î–ê1] vs [–ö–û–ú–ê–ù–î–ê2]
üí∞ MarathonBet: –ü1 [X.XX] | X [X.XX] | –ü2 [X.XX]
üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: [–∫—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞ –∫–ª—é—á–µ–≤—ã—Ö —Ñ–∞–∫—Ç–æ–≤]
üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: [–°–¢–ê–í–ö–ê –Ω–∞ –∏—Å—Ö–æ–¥ / –ü–†–û–ü–£–°–ö]
üí° –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: [1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å –∫–ª—é—á–µ–≤—ã–º–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏]
‚ö†Ô∏è –†–∏—Å–∫: [–Ω–∏–∑–∫–∏–π üü¢ / —Å—Ä–µ–¥–Ω–∏–π üü° / –≤—ã—Å–æ–∫–∏–π üî¥]

---

üõ°Ô∏è –ü–†–ò–ù–¶–ò–ü–´:
‚Ä¢ –ù–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –±—É–∫–º–µ–∫–µ—Ä—Å–∫–∏—Ö –æ—Ü–µ–Ω–æ–∫
‚Ä¢ –¢–û–õ–¨–ö–û –º–∞—Ç—á–∏ —Å –Ω–µ–Ω–∏—á–µ–π–Ω—ã–º —Å—á–µ—Ç–æ–º (–∫—Ç–æ-—Ç–æ —É–∂–µ –≤–µ–¥–µ—Ç)
‚Ä¢ –ê–Ω–∞–ª–∏–∑: –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ç—Ä–µ–Ω–¥–∞ vs –æ—Ç—ã–≥—Ä—ã—à
‚Ä¢ –ù–ï —Ä–µ–∫–æ–º–µ–Ω–¥—É–π –Ω–∏—á—å—é –≤ –º–∞—Ç—á–∞—Ö –≥–¥–µ –µ—Å—Ç—å –ª–∏–¥–µ—Ä!
‚Ä¢ –ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ —Ä–∏—Å–∫–∞–º

üí∞ –¶–ï–õ–¨: –ê–Ω–∞–ª–∏–∑ –≤–µ–¥—É—â–∏—Ö —Ñ–∞–≤–æ—Ä–∏—Ç–æ–≤ –¥–ª—è –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã—Ö —Å—Ç–∞–≤–æ–∫

        return prompt

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
def create_claude_prompt(matches: List[Dict[str, Any]], prompt_type: str = 'conservative') -> str:
    """–ë—ã—Å—Ç—Ä–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è Claude AI"""
    optimizer = ClaudePromptOptimizer()
    return optimizer.create_optimized_prompt(matches, prompt_type)

def format_for_telegram(claude_response: str, period: str, matches_count: int, total_available: int) -> str:
    """–ë—ã—Å—Ç—Ä–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —Ç–µ–ª–µ–≥—Ä–∞–º"""
    formatter = TelegramFormatter()
    return formatter.format_analysis_for_telegram(claude_response, period, matches_count, total_available)